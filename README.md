# Perform malware scan analysis of on-prem servers with DRS

We are developing a blog post and related reference solution to enable on-prem customers perform file-based malware scan of their on-prem servers. 

Customers will be able to perform this by following the steps documented in the upcoming blog post. Essentially, the customer will deploy our reference solution (via the aws-samples GitHub organization) using CloudFormation. 

[Link to our WorkDocs repository](https://amazon.awsapps.com/workdocs/index.html#/folder/a4a6f7e6e03ccf0cf9a99f2f32038bb5d201d7d0537636c27af9396e4cfa5951)

The solution consists basically of two lambda funcions and a DynamoDB table. The first lambda function (the "Run") function is meant to be executed from an EventBridge cron-like schedule. The function receives a list of DRS source server names, and triggers malware scan detection using the GuardDuty SDK. In order to do that, it queries the DRS and EC2 APIs to find out the id of the replicating EC2 instance. After triggering malware scan detection, the function annotates the names of the DRS source servers in the DynamoDB table, using the id of the scan operation as index. These will be later referenced by the second lambda function (below).

After malware detection completes. the related SecurityHub finding triggers the second lambda provided by this solution (AnnotateFindings). The function essentially annotates the finding with the DRS source server name(s) (recall that the malware scan operation was triggered on behalf of the replicating EC2 instance). The AnnotateFindings lambda retrieves the DRS source server name(s) by querying the DynamoDB table using the id of the scan operation, which is provided in the message sent via the EventBridge event.

Please refer to the workdocs folder above for the CloudFormation template and architecture diagrams and feel free to contact us should you need anything else. Thank you,

```
mongerod@
frthierr@
leansan@
```

## Usage

#### Pre-requisites

- An AWS Account.
- Amazon DRS set up and running.
- IAM Privileges to deploy the components of this solution.
- Amazon GuardDuty enabled
- Amazon Security Hub enabled

> **Warning**  
 Currently, GuardDuty Malware scan does not support EBS volumes encrypted with EBS-managed keys. If you want to use this solution to scan your on-prem (or other-cloud) servers replicated with DRS, you need to setup DRS replication with your own encryption key in KMS. If you are currently using EBS-managed keys with your replicating servers, you can change encryption settings to use your own KMS key in the DRS console.

#### Deployment

1 - **Create a Cloud9 environment** with Amazon Linux in your AWS account. Open your Cloud9 environment and clone the code in this repository.

```bash
cd drs-malware-scan
```

2 - **Deploy the CDK stack** by running the following command in the Cloud9 terminal and confirm the deployment

```bash
npm install
cdk bootstrap
cdk deploy
```

3 - **Setup malware scan for your existing DRS source server(s)**. The list of servers to be scanned in stored in a DynamoDB table created by the cdk stack, with prefix `DrsMalwareScanStack-ServersDDBTable*`. Create DynamoDB items for each Source Server being replicated by Amazon Elastic Disaster Recovery (DRS). 

4 - **Configure the EventBridge rule to schedule the Scanning**. Edit the rule with prefix `DrsMalwareScanStack-ScheduleRule`, to set the scanning frequency of the malware scan analysis and the list of DRS source server(s) to analyze. Also this rule is disabled by default, please enable it.

5 - **Make sure that the DRS source server(s) configured in step #3 are continuously deplicating and in a healthy replication state**. This is required because of a limitation in the GuardDuty API: by the time of this writing, there is no public AWS API to scan DRS snapshots. The only way to perform malware scan over DRS source server(s) data is to perform a scan on the replicating EC2 instance managed by DRS. If replication is not running in a healthy state, your DRS malware scan may not complete successfully.

#### Troubleshooting

Both `MalwareScan` and `AnnotateFindings` lambdas log to `CloudWatch`. You can verify the execution of the solution by inspecting the CloudWatch log groups, `/aws/lambda/$StackName-MalwareScan` and `/aws/lambda/$StackName-AnnotateFindings`.

For example, when malware scan kicks off successfully, the log group `/aws/lambda/$StackName-MalwareScan` should contain:

```
info: malware scan initiated EC2 instance i-0818c1a6f248d76da. DRS scan id 1c4680800e45ea2d8a58f0625f129973, source server(s) [MyOnPremServer], timestamp 1690767872.
info: summary: 1 DRS source servers, 1 malware scan(s) attempted, 1 initiated, 0 error(s).
```

The malware scan operation should complete after a few minutes. When GuardDuty finds malware, it generates a SecurityHub finding: the solution intercepts this event and runs the `$StackName-AnnotateFindings` lambda to augment the SecurityHub finding with a note containing the name(s) of the DRS source server(s) containing malware. The log group `/aws/lambda/$StackName-MalwareScan` should contain:

```
info: updated SecurityHub finding id arn:aws:guardduty:us-east-1:$accountid:detector/d8b20f9a36b6bd6a943d27f76b81de13/finding/7cc4d4d79661d84a71590b040e167b1f set DRS source Server(s) to: MyOnPremServer.
```

#### Cleanup

1 - Run the following commands in your terminal:

```bash
cdk destroy
```

2 - (Optional) Delete the CloudWatch log streams `/aws/lambda/$StackName-MalwareScan` and `/aws/lambda/$StackName-AnnotateFindgins`.

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

# Authors
- [Leandro Santi](https://www.linkedin.com/in/leandro-santi-ba617b87/)
- [Sergey Pugachev](https://www.linkedin.com/in/rodrigo-monge-b86b714/)
- [Thierry Francois](https://www.linkedin.com/in/thierry-f-61332a179/)

## License

This sample code is licensed under the MIT-0 License. See the LICENSE file.
