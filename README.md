# Perform malware scan analysis of on-prem servers using AWS services

## Challenges with on-premises malware detection

It can be difficult for security teams to continuously monitor all on-premises servers due to budget and resource constraints. Signature-based antivirus alone is insufficient as modern malware uses various obfuscation techniques. Server admins may lack visibility into security events across all servers historically. Determining compromised systems and safe backups to restore from during incidents is challenging without centralized monitoring and alerting. It is onerous for server admins to setup and maintain additional security tools for advanced threat detection. The rapid mean time to detect and remediate infections is critical but difficult to achieve without the right automated solution.

Determining which backup image is safe to restore from during incidents without comprehensive threat intelligence is another hard problem. Even if backups are available, without knowing when exactly a system got compromised, it is risky to blindly restore from backups. This increases the chance of restoring malware and losing even more valuable data and systems during incident response. There is a need for an automated solution that can pinpoint the timeline of infiltration and recommend safe backups for restoration.

## How to use AWS services to address these challenges

The solution leverages [AWS Elastic Disaster Recovery (AWS DRS)](https://aws.amazon.com/disaster-recovery/), [Amazon GuardDuty](https://aws.amazon.com/guardduty/) and [AWS Security Hub](https://aws.amazon.com/security-hub/) to address the challenges of malware detection for on-premises servers.

This combo of services provides a cost-effective way to continuously monitor on-premises servers for malware without impacting performance. It also helps determine safe recovery point in time backups for restoration by identifying timeline of compromises through centralized threat analytics.

AWS Elastic Disaster Recovery (AWS DRS) minimizes downtime and data loss with fast, reliable recovery of on-premises and cloud-based applications using affordable storage, minimal compute, and point-in-time recovery.

Amazon GuardDuty is a threat detection service that continuously monitors your AWS accounts and workloads for malicious activity and delivers detailed security findings for visibility and remediation.

AWS Security Hub is a cloud security posture management (CSPM) service that performs security best practice checks, aggregates alerts, and enables automated remediation.

## Architecture

![sample](docs/DRSMalwareScanArchitecture.png "Architecture Diagram")

## Solution description

The Malware Scan solution assumes on-premises servers are already being replicated with AWS DRS, and Amazon GuardDuty & AWS Security Hub are enabled. The cdk stack in this repository will only deploy the boxes labelled as DRS Malware Scan in the architecture diagram.

1. *AWS DRS* is replicating source servers from the on-premises environment to AWS (or from any cloud provider for that matter). For further details about setting up AWS DRS please follow the [Quick Start Guide](https://docs.aws.amazon.com/drs/latest/userguide/quick-start-guide-gs.html).
2. *Amazon GuardDuty* is already enabled. 
3. *AWS Security Hub* is already enabled.
4. The Malware Scan solution is triggered by a Schedule Rule in *Amazon EventBridge* (with prefix *DrsMalwareScanStack-ScheduleScanRule*). You can adjust the scan frequency as needed (i.e. once a day, a week, etc). 
5. The Schedule Rule in Amazon EventBridge triggers the *Submit Orders* lambda function (with prefix *DrsMalwareScanStack-SubmitOrders*) which gathers the source servers to scan from the *Source Servers* DynamoDB table. 
6. Orders are placed on the SQS FIFO queue named *Scan Orders* (with prefix *DrsMalwareScanStack-ScanOrdersfifo*). The queue is used to serialize scan requests mapped to the same DRS instance, preventing a race condition.
7. The *Process Order* lambda picks a malware scan order from the queue and enriches it, preparing the upcoming malware scan operation. For instance, it inserts the id of the replicating DRS instance associated to the DRS source server provided in the order. The output of *Process Order* are malware scan commands containing all the necessary information to invoke GuardDuty malware scan.
8. Malware scan operations are tracked using the *DRSVolumeAnnotationsDDBTable* at the volume-level, providing reporting capabilities.
9. Malware scan commands are inserted in the *Scan Commands* SQS FIFO queue (with prefix *DrsMalwareScanStack-ScanCommandsfifo*) to increase resiliency.
10. The *Process Commands* function submits queued scan commands at a maximum rate of 1 command per second to avoid API throttling. It triggers the [on-demand malware scan function](https://docs.aws.amazon.com/guardduty/latest/ug/on-demand-malware-scan.html) provided by Amazon GuardDuty.
11. The execution of the on-demand Amazon GuardDuty Malware job can be monitored from the Amazon GuardDuty service.
12. The outcome of malware scan job is routed to Amazon Cloudwath Logs.
13. The *Subscription Filter* lambda function receives the outcome of the scan and tracks the result using DynamoDB (step #14).
14. The *DRS Instance Annotations* DynamoDB Table tracks the status of the malware scan job at the instance level.
15. The CDK stack named ScanReportStack deploys the *Scan Report* lambda function (with prefix *ScanReportStack-ScanReport*) to populate the *Amazon S3 bucket* with prefix *scanreportstack-scanreportbucket*. 
16. AWS Security Hub aggregates and correlates findings from Amazon GuardDuty. 
17. The Security Hub finding event is caught by an *EventBridge Rule* (with prefix *DrsMalwareScanStack-SecurityHubAnnotationsRule*)
18. The *Security Hub Annotations* lambda function (with prefix *DrsMalwareScanStack-SecurityHubAnnotation*) generates additional Notes (Annotations) to the Finding with contextualized information about the source server being affected. This additional information can be seen in the Notes section within the Security Hub Finding.
19. The follow-up activities will depend on the incident response process being adopted. For example based on the date of the infection, AWS DRS can be used to perform a point in time recovery using a snapshot previous to the date of the malware infection.
20. In a Multi-Account scenario, this solution can be deployed directly on the AWS account hosting the AWS DRS solution. The Amazon GuardDuty findings will be automatically sent to the centralized Security Account.

## Usage

### Pre-requisites

- An AWS Account.
- Amazon Elastic Disaster Recovery (DRS) configured, with at least 1 server source in sync. If not, please check this [documentation]((https://docs.aws.amazon.com/drs/latest/userguide/quick-start-guide-gs.html)). The Replication Configuration must consider EBS encryption using Custom Managed Key (CMK) from AWS Key Management Service (AWS KMS). Amazon GuardDuty Malware Protection does not support default AWS managed key for EBS.
- IAM Privileges to deploy the components of this solution.
- Amazon GuardDuty enabled. If not, please check this [documentation](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_settingup.html)
- Amazon Security Hub enabled. If not, please check this [documentation](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-enable.html)

    > **Warning**  
    ⚠️ Currently, Amazon GuardDuty Malware scan does not support EBS volumes encrypted with EBS-managed keys. If you want to use this solution to scan your on-prem (or other-cloud) servers replicated with DRS, you need to setup DRS replication with your own encryption key in KMS. If you are currently using EBS-managed keys with your replicating servers, you can change encryption settings to use your own KMS key in the DRS console.

### Deploy

1. **Create a Cloud9 environment** with Ubuntu image (at least t3.small for better performance) in your AWS account. Open your Cloud9 environment and clone the code in this repository. Note: Amazon Linux 2 has node v16 which is not longer supported since 2023-09-11
    ```
    git clone https://github.com/aws-samples/drs-malware-scan
    ```

    ```
    cd drs-malware-scan
    ```

2. **Deploy the CDK stack** by running the following command in the Cloud9 terminal and confirm the deployment

    ```
    npm install
    ```
    ```
    cdk bootstrap
    ```
    ```
    cdk deploy --all
    ```
    **Note**  
    The solution is made of 2 stacks:
    * DrsMalwareScanStack: it deploys all resources needed for malware scanning feature. This stack is mandatory. If you want to deploy only this stack you can run `cdk deploy DrsMalwareScanStack`   
    * ScanReportStack: it deploys the resources needed for reporting (Amazon Lambda and Amazon S3). This stack is optional. If you want to deploy only this stack you can run `cdk deploy ScanReportStack`
    
    If you want to deploy both stacks you can run `cdk deploy --all` 
    

### Configuration

1. **Make sure that the DRS source server(s) are continuously replicating and in a healthy replication state**. This is required because of a limitation in the GuardDuty API: by the time of this writing, there is no public AWS API to scan DRS snapshots. The only way to perform malware scan over DRS source server(s) data is to perform a scan on the replicating EC2 instance managed by DRS. If replication is not running in a healthy state, your DRS malware scan may not complete successfully. You have to confirm *ReadyforRecovery=Ready*

2. **Select the Source Servers**. Copy the source servers names that you would like the solution to scan and paste it in a text editor. This will be used in the next step.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;![sample](docs/animated-drs.gif)

3. **Setup malware scan for your existing DRS source server(s)**. The list of servers to be scanned in stored in a DynamoDB table created by the cdk stack, with prefix *DrsMalwareScanStack-SourceServersDDBTable*. Create DynamoDB items for each Source Server being replicated by Amazon Elastic Disaster Recovery (DRS). You'll need to create DynamoDB items for each replication DRS Source server.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;![sample](docs/animated-dynamodb.gif)

4. **Configure the EventBridge rule to schedule the Scanning**. Edit the rule with prefix *DrsMalwareScanStack-ScheduleScanRule*, to set the scanning frequency of the malware scan analysis and the list of DRS source server(s) to analyze. Also this rule is disabled by default, please enable it.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;![sample](docs/animated-eventbridge.gif)

5. **Check that Amazon GuardDuty triggered a malware scan operation** 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;![sample](docs/animated-guardduty.gif)

6. **Check AWS SecurityHub for potential malware findings on on-prem servers**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;![sample](docs/animated-security-hub.gif)

7. **Optional: Check the malware scan report file on S3**
    * Enable eventbridge rule
    ![sample](docs/animated-schedule-scanreport.gif)
    
    * Check report
    ![sample](docs/animated-verify-scanreport.gif)

8. **Optional: For Multiaccount configuration** In case you had a designated security account to centralize all security findings as part of a multiaccount strategy, this solution will also work.  


### Troubleshooting

All lambda functions route logs to `Amazon CloudWatch`. You can verify the execution of each function by inspecting the proper CloudWatch log groups for each function, `/aws/lambda/DrsMalwareScanStack-*`.

The malware scan operation should complete after a few minutes, depending on the size of the volumes. When GuardDuty finds malware, it generates a SecurityHub finding: the solution intercepts this event and runs the `$StackName-SecurityHubAnnotations` lambda to augment the SecurityHub finding with a note containing the name(s) of the DRS source server(s) containing malware. 

The SQS FIFO queues can be monitored using the *Messages available* and *Message in flight* metrics from the AWS SQS console

The DRS Volume Annotations DynamoDB tables keeps track of the status of each Malware scan operation.

Amazon GuardDuty has documented reasons to skip scan operations. For further information please check [Reasons for skipping resource during malware scan](https://docs.aws.amazon.com/guardduty/latest/ug/malware-protection-auditing-scan-logs.html)

In order to analize logs from Amazon GuardDuty Malware scan operations, you can check `/aws/guardduty/malware-scan-events` Amazon Cloudwatch LogGroup. The default log retention period for this log group is 90 days, after which the log events are deleted automatically. 

### Cleanup

1. Run the following commands in your terminal:

    ```
    cdk destroy --all
    ```

2. (Optional) Delete the CloudWatch log groups associated with Lambda Functions.

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## Authors
- [Rodrigo Monge](https://www.linkedin.com/in/rodrigo-monge-b86b714/)
- [Thierry Francois](https://www.linkedin.com/in/thierry-f-61332a179/)
- [Diego Pérez Holguín](https://www.linkedin.com/in/diegoperezholguin/)
- [Leandro Santi](https://www.linkedin.com/in/leandro-santi-ba617b87/)

## License

This sample code is licensed under the MIT-0 License. See the LICENSE file.
