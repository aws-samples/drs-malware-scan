# Perform malware scan analysis of on-prem servers using AWS services

## Challenges with on-premises malware detection

It can be difficult for security teams to continuously monitor all on-premises servers due to budget and resource constraints. Signature-based antivirus alone is insufficient as modern malware uses various obfuscation techniques. Server admins may lack visibility into security events across all servers historically. Determining compromised systems and safe backups to restore from during incidents is challenging without centralized monitoring and alerting. It is onerous for server admins to setup and maintain additional security tools for advanced threat detection. The rapid mean time to detect and remediate infections is critical but difficult to achieve without the right automated solution.

Determining which backup image is safe to restore from during incidents without comprehensive threat intelligence is another hard problem. Even if backups are available, without knowing when exactly a system got compromised, it is risky to blindly restore from backups. This increases the chance of restoring malware and losing even more valuable data and systems during incident response. There is a need for an automated solution that can pinpoint the timeline of infiltration and recommend safe backups for restoration.

## How to use AWS services to address these challenges

The solution leverages [AWS Elastic Disaster Recovery (AWS DRS)](https://aws.amazon.com/disaster-recovery/), [Amazon GuardDuty](https://aws.amazon.com/guardduty/) and [AWS Security Hub](https://aws.amazon.com/security-hub/) to address the challenges of malware detection for on-premises servers.

This combination of services provides a cost-effective way to continuously monitor on-premises servers for malware without impacting performance. It also helps determine safe recovery point in time backups for restoration by identifying timeline of compromises through centralized threat analytics.

DRS minimizes downtime and data loss with fast, reliable recovery of on-premises and cloud-based applications using affordable storage, minimal compute, and point-in-time recovery.

Amazon GuardDuty is a threat detection service that continuously monitors your AWS accounts and workloads for malicious activity and delivers detailed security findings for visibility and remediation.

AWS Security Hub is a cloud security posture management (CSPM) service that performs security best practice checks, aggregates alerts, and enables automated remediation.

## Architecture

![sample](docs/Architecture.jpg "Architecture Diagram")

## Solution description

This solution assumes that on-prem servers are already setup and replicating with AWS DRS; and also Amazon GuardDuty & AWS Security Hub are enabled. In a Multi-Account scenario, this solution can be deployed directly on the AWS account hosting the AWS DRS solution. The Amazon GuardDuty findings will be automatically sent to the centralized Security Account.

AWS DRS is replicating source servers from the on-premises environment to AWS (or from any cloud provider). For more details related to DRS please follow the [Quick Start Guide](https://docs.aws.amazon.com/drs/latest/userguide/quick-start-guide-gs.html).

Amazon GuardDuty Malware Protection is triggered by a Schedule Rule in Amazon EventBridge, its frequency would depend on the requirement (i.e. once a day, a week, etc). The Schedule Rule in Amazon EventBridge triggers an Amazon Lambda function which gathers the source servers to scan from the DynamoDB table. Then it runs an [on-demand Amazon GuardDuty Malware scan](https://docs.aws.amazon.com/guardduty/latest/ug/on-demand-malware-scan.html).
This job scans the AWS DRS Replication Server instances for potential threats that could indicate a malware infection. Findings are sent to Security Hub for further analysis.

AWS Security Hub aggregates and correlates findings from Amazon GuardDuty. It generates additional Notes (Annotations) to the Finding with contextualized information about the source server being affected. The follow-up activities will depend on the incident response process being adopted. For example based on the date of the infection, AWS DRS can be used to perform a point in time recovery using a snapshot previous to the date of the malware infection.

<!--- To BE REWRITTEN based on the final solution
The solution consists basically of two lambda funcions and a DynamoDB table. The first lambda function (the "Run") function is meant to be executed from an EventBridge cron-like schedule. The function receives a list of DRS source server names, and triggers malware scan detection using the GuardDuty SDK. In order to do that, it queries the DRS and EC2 APIs to find out the id of the replicating EC2 instance. After triggering malware scan detection, the function annotates the names of the DRS source servers in the DynamoDB table, using the id of the scan operation as index. These will be later referenced by the second lambda function (below).

After malware detection completes. the related SecurityHub finding triggers the second lambda provided by this solution (AnnotateFindings). The function essentially annotates the finding with the DRS source server name(s) (recall that the malware scan operation was triggered on behalf of the replicating EC2 instance). The AnnotateFindings lambda retrieves the DRS source server name(s) by querying the DynamoDB table using the id of the scan operation, which is provided in the message sent via the EventBridge event.
--->

## Usage

### Pre-requisites

- An AWS Account.
- Amazon Elastic Disaster Recovery (DRS) configured, with at least 1 server source in sync. If not, please check this [documentation]((https://docs.aws.amazon.com/drs/latest/userguide/quick-start-guide-gs.html))
- IAM Privileges to deploy the components of this solution.
- Amazon GuardDuty enabled. If not, please check this [documentation](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_settingup.html)
- Amazon Security Hub enabled. If not, please check this [documentation](https://docs.aws.amazon.com/securityhub/latest/userguide/securityhub-enable.html)

    > **Warning**  
    ⚠️ Currently, Amazon GuardDuty Malware scan does not support EBS volumes encrypted with EBS-managed keys. If you want to use this solution to scan your on-prem (or other-cloud) servers replicated with DRS, you need to setup DRS replication with your own encryption key in KMS. If you are currently using EBS-managed keys with your replicating servers, you can change encryption settings to use your own KMS key in the DRS console.

### Deploy

1. **Create a Cloud9 environment** with Amazon Linux in your AWS account. Open your Cloud9 environment and clone the code in this repository.
    ```
    git clone https://github.com/aws-samples/drs-malware-scan
    ```

    ```
    cd drs-malware-scan
    ```

2. **Deploy the CDK stack** by running the following command in the Cloud9 terminal and confirm the deployment

    ```
    npm install
    ```
    ```
    cdk bootstrap
    ```
    ```
    cdk deploy
    ```

    NB. The deploy takes ~ 5 minutes.

3. **Setup malware scan for your existing DRS source server(s)**. The list of servers to be scanned in stored in a DynamoDB table created by the cdk stack, with prefix `DrsMalwareScanStack-ServersDDBTable`.

    You'll need to create DynamoDB items for each replication DRS source server: this can be done e.g. through the AWS console web GUI or (alternatively) the AWS command line interface by running the following:

    ```
    export DDB_SOURCE_SERVERS_TABLE='DrsMalwareScanStack-ServersDDBTable-$SUFFIX'
    ```

    Remember to replace `$SUFFIX` above with the actual value of your particular solution instance. Now, to set up DRS source server `qubuntu` for malware scan, run:

    ```
    aws dynamodb put-item --table-name=$DDB_SOURCE_SERVERS_TABLE --item '{ "server_id": { "S": "qubuntu" } }'
    ```

    Repeat the previous command for each and every DRS source server(s). To get the full list of DRS source server name(s) in your existing setup, please refer e.g. to your DRS web console.

4. **Make sure that the DRS source server(s) configured in step #3 are continuously deplicating and in a healthy replication state**. This is required because of a limitation in the GuardDuty API: by the time of this writing, there is no public AWS API to scan DRS snapshots. The only way to perform malware scan over DRS source server(s) data is to perform a scan on the replicating EC2 instance managed by DRS. If replication is not running in a healthy state, your DRS malware scan may not complete successfully.

5. **Configure the EventBridge rule to schedule the scanning**. Edit the rule with prefix `DrsMalwareScanStack-ScheduleRule`, to set the scanning frequency of the malware scan analysis and the list of DRS source server(s) to analyze. This rule is disabled by default - please enable it.

### Troubleshooting

Both `MalwareScan` and `AnnotateFindings` lambdas log to `CloudWatch`. You can verify the execution of the solution by inspecting the CloudWatch log groups, `/aws/lambda/$StackName-MalwareScan` and `/aws/lambda/$StackName-AnnotateFindings`.

For example, when malware scan kicks off successfully, the log group `/aws/lambda/$StackName-MalwareScan` should contain:

```
info: malware scan initiated EC2 instance i-0818c1a6f248d76da. DRS scan id 1c4680800e45ea2d8a58f0625f129973, source server(s) [MyOnPremServer], timestamp 1690767872.
info: summary: 1 DRS source servers, 1 malware scan(s) attempted, 1 initiated, 0 error(s).
```

The malware scan operation should complete after a few minutes. When GuardDuty finds malware, it generates a SecurityHub finding: the solution intercepts this event and runs the `$StackName-AnnotateFindings` lambda to augment the SecurityHub finding with a note containing the name(s) of the DRS source server(s) containing malware. The log group `/aws/lambda/$StackName-MalwareScan` should contain:

```
info: updated SecurityHub finding id arn:aws:guardduty:us-east-1:$accountid:detector/d8b20f9a36b6bd6a943d27f76b81de13/finding/7cc4d4d79661d84a71590b040e167b1f set DRS source Server(s) to: MyOnPremServer.
```

### Cleanup

1. Run the following commands in your terminal:

    ```
    cdk destroy
    ```

2. (Optional) Delete the CloudWatch log streams `/aws/lambda/$StackName-MalwareScan` and `/aws/lambda/$StackName-AnnotateFindgins`.

3. (Optional) Delete the AWS Cloud9 environment created while deploying this solution.

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## Authors
- [Thierry Francois](https://www.linkedin.com/in/thierry-f-61332a179/)
- [Rodrigo Monge](https://www.linkedin.com/in/rodrigo-monge-b86b714/)
- [Leandro Santi](https://www.linkedin.com/in/leandro-santi-ba617b87/)

## License

This sample code is licensed under the MIT-0 License. See the LICENSE file.
